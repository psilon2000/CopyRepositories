
# Скрипт для зеркалирования репозиториев в Git

В этом документе описан функционал, способы использования и примеры работы PowerShell-скрипта `copyreps.ps1`, который зеркалирует Git-репозитории в указанную группу GitLab.

```powershell
.\copyreps.ps1 -RepoListPath .\repos.txt -TargetGroup git@gitlab.sensetower.io:testupload 
```

## Содержание
1. [Обзор](#обзор)
2. [Требования](#требования)
3. [Параметры](#параметры)
4. [Функционал](#функционал)
5. [Ограничения](#ограничения)
6. [Примеры использования](#примеры-использования)
7. [Логирование](#логирование)
8. [Режим Dry-Run](#режим-dry-run)
9. [Подробный лог (Verbose)](#подробный-лог-verbose)
10. [Инкрементальные обновления](#инкрементальные-обновления)
11. [Пример файла со списком репозиториев](#пример-файла-со-списком-репозиториев)

---

## Обзор
Скрипт автоматизирует копирование (зеркалирование) Git-репозиториев из разных источников (локальных или удалённых) в одну группу на GitLab. Поддерживает полный клон, инкрементальные обновления, «сухой» запуск и настройку уровня логирования.

## Требования
- PowerShell 5.1 или PowerShell Core (7+)
- Установленный Git, доступный в PATH
- Настроенный SSH-доступ к целевому GitLab-серверу

## Параметры

| Параметр           | Тип       | Обязательно | Описание                                                                                 |
|--------------------|-----------|-------------|------------------------------------------------------------------------------------------|
| `-RepoListPath`    | `string`  | Да          | Путь к текстовому файлу со списком URL репозиториев (по одному на строку).              |
| `-TargetGroup`     | `string`  | Да          | SSH-префикс группы на GitLab (например, `git@gitlab.com:MyGroup`).                       |
| `-TempRoot`        | `string`  | Нет         | Папка для временных зеркальных клонов (по умолчанию `$env:TEMP\GitMirror`).            |
| `-RetryCount`      | `int`     | Нет         | Число повторных попыток при неудачном клонировании (по умолчанию `2`).                    |
| `-Incremental`     | `switch`  | Нет         | Если указано, скрипт обновляет существующие зеркала вместо полного клона.                 |
| `-VerboseLogs`     | `switch`  | Нет         | Если указано, включает детальный вывод (DEBUG) в лог-файл.                                 |
| `-DryRun`          | `switch`  | Нет         | Если указано, скрипт имитирует действия без выполнения `git clone` и `git push`.          |
| `-LogFile`         | `string`  | Нет         | Путь к файлу логов (по умолчанию `./migration.log`).                                       |

## Функционал
- **Полное зеркалирование**: выполняет `git clone --mirror`, затем `git push --mirror --force`.
- **Инкрементальные обновления**: при существующем зеркале делает `git remote update --prune`.
- **Dry-Run**: выводит команды, которые бы были выполнены, без реального воздействия.
- **Подробное логирование**: сохраняет вывод всех команд git при включении `-VerboseLogs`.
- **Обработка ошибок**: повторяет клонирование при сбоях, фиксирует ошибки пуша.

## Ограничения
- **Не отслеживает и не снимает защиту веток**.  
  Если в целевых проектах на GitLab включена защита ветки (Protected Branch), скрипт не сможет выполнить принудительный (`--force`) пуш, и в удалённом репозитории история не обновится.  
- **Ветки должны быть unprotected** (снята опция защиты для force-пушей) в настройках проекта на GitLab.

## Примеры использования

### 1. Полный перенос
```powershell
.\copyreps.ps1 `
  -RepoListPath .
epos.txt `
  -TargetGroup git@gitlab.com:MyGroup
```

### 2. Инкрементальное обновление
```powershell
.\copyreps.ps1 `
  -RepoListPath .
epos.txt `
  -TargetGroup git@gitlab.com:MyGroup `
  -Incremental
```

### 3. Dry-Run (тестовый прогон)
```powershell
.\copyreps.ps1 `
  -RepoListPath .
epos.txt `
  -TargetGroup git@gitlab.com:MyGroup `
  -DryRun
```

### 4. Подробное логирование
```powershell
.\copyreps.ps1 `
  -RepoListPath .
epos.txt `
  -TargetGroup git@gitlab.com:MyGroup `
  -VerboseLogs
```

## Логирование
- Сообщения уровней `INFO`, `WARN`, `ERROR` выводятся в консоль и записываются в файл.
- Сообщения `DEBUG` записываются в файл только при `-VerboseLogs`.
- Файл логов настраивается параметром `-LogFile`.

## Режим Dry-Run
Включите `-DryRun`, чтобы увидеть список действий без выполнения `git clone`, `git push` и очистки папок.

## Подробный лог (Verbose)
Параметр `-VerboseLogs` сохраняет полный вывод команд git для отладки.

## Инкрементальные обновления
Параметр `-Incremental` сохраняет ранее созданные зеркала в `$TempRoot` и скачивает только изменения, ускоряя повторные запуски.

## Пример файла со списком репозиториев
Создайте текстовый файл `repos.txt`, содержащий записи в формате:

```text
# Список репозиториев для миграции
git@github.com:OldOrg/RepoOne.git
https://gitlab.com/OtherGroup/RepoTwo.git
C:\Projects\LocalRepoThree.git
ssh://git@gitlab.example.com:2222/SomeGroup/RepoFour.git
```
- **Комментарии**: строки, начинающиеся с `#`, игнорируются.
- **Поддерживаемые форматы**: SSH-URL, HTTPS-URL и локальные пути.

---

_Для вопросов и предложений по улучшению скрипта обращайтесь к разработчику._
